<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lupron Depot Syringe - True Ambient Occlusion</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; background-color: #f4f4f4; font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .container { display: flex; height: 100vh; width: 100vw; }
        
        .viz-viewport { 
            flex: 2; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            padding: 2vmin; 
            box-sizing: border-box;
            position: relative;
        }

        .model-card { 
            width: 100%; 
            height: 100%; 
            border-radius: 12px; 
            position: relative; 
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            /* Slightly lighter center for better contrast with new AO */
            background: radial-gradient(circle at center, #ffffff 20%, #ededed 100%);
        }

        /* --- Ever-present Viewport Header --- */
        .viewport-header {
            position: absolute;
            top: 40px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            pointer-events: none;
            text-align: center;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            padding: 20px 30px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.04);
            width: 80%;
            max-width: 650px;
        }
        .viewport-header h2 {
            margin: 0 0 8px 0;
            font-size: 22px;
            font-weight: 800;
            color: #6a1c3a; 
        }
        .viewport-header p {
            margin: 0 auto;
            font-size: 15px;
            color: #555;
            line-height: 1.5;
        }

        #webgl-canvas {
            width: 100%;
            height: 100%;
            display: block;
            outline: none;
        }

        /* --- 2D Annotations (Story Steps) --- */
        .annotation {
            position: absolute;
            opacity: 0;
            transition: opacity 0.5s ease, transform 0.5s ease;
            pointer-events: none;
            background: #ffffff;
            padding: 12px 24px;
            border-radius: 30px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transform: translateY(15px);
            z-index: 20;
        }
        .annotation.visible {
            opacity: 1;
            transform: translateY(0);
        }
        .annotation-title { 
            font-weight: 700; 
            color: #6a1c3a; 
            font-size: 15px; 
        }
        
        /* Adjusted to stay in the negative space while model is centered */
        #anno-needle { top: 30%; right: 15%; }
        #anno-safety { top: 35%; left: 15%; }
        #anno-microspheres { top: 40%; right: 15%; }
        #anno-diluent { top: 50%; left: 15%; }
        #anno-dual { top: 45%; right: 15%; }
        #anno-plunger { bottom: 25%; right: 15%; }

        /* --- Schematic Labels & Leader Lines --- */
        .schematic-label {
            position: absolute; display: flex; align-items: center;
            pointer-events: none; z-index: 15; opacity: 0; transition: opacity 0.4s ease;
        }
        .schematic-label.show { opacity: 1; }
        .schematic-label.left { flex-direction: row-reverse; transform: translate(-100%, -50%); }
        .schematic-label.right { flex-direction: row; transform: translate(0%, -50%); }
        
        .schematic-label.left::before { content: ''; width: 50px; height: 1px; background: #6a1c3a; margin-left: 10px; }
        .schematic-label.right::before { content: ''; width: 50px; height: 1px; background: #6a1c3a; margin-right: 10px; }
        
        .schematic-label span {
            font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            color: #6a1c3a; background: rgba(255, 255, 255, 0.85); padding: 4px 8px; border-radius: 4px;
            text-align: center; border: 1px solid rgba(106, 28, 58, 0.2); backdrop-filter: blur(4px);
        }

        /* --- Rail --- */
        .rail { flex: 1; overflow-y: scroll; scroll-snap-type: y mandatory; background: #ffffff; border-left: 1px solid #e0e0e0; }
        .text-block { height: 100vh; display: flex; align-items: center; justify-content: center; scroll-snap-align: start; padding: 0 40px; }
        
        .content-box { 
            padding: 35px; 
            border-radius: 16px; 
            background: #ffffff; 
            transition: 0.4s ease; 
            opacity: 0.3; 
            max-width: 500px; 
            transform: scale(0.95);
        }
        .text-block.active .content-box { 
            opacity: 1; 
            transform: scale(1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.06); 
        }
        .block-label { 
            font-weight: 800; 
            color: #6a1c3a; 
            font-size: 1.1rem; 
            display: block; 
            margin-bottom: 12px; 
        }
        .content-box p { line-height: 1.7; color: #444; margin: 0; font-size: 1.1rem; }

        /* Scroll Prompt */
        .scroll-prompt {
            display: flex;
            align-items: center;
            margin-top: 25px;
            font-weight: 700;
            font-size: 13px;
            color: #6a1c3a;
            text-transform: uppercase;
            letter-spacing: 1px;
            animation: bounce 2s infinite;
        }
        .scroll-prompt svg { margin-left: 8px; }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(5px); }
            60% { transform: translateY(3px); }
        }

        @media (max-width: 768px) {
            .container { flex-direction: column; }
            .viz-viewport { flex: none; height: 55vh; width: 100%; padding: 0; }
            .model-card { border-radius: 0; }
            .viewport-header { top: 15px; width: 90%; padding: 15px; }
            .viewport-header h2 { font-size: 18px; }
            .viewport-header p { font-size: 13px; }
            .rail { flex: none; height: 45vh; width: 100%; border-left: none; }
            .text-block { height: 45vh; padding: 0 20px; }
            .content-box { padding: 25px; font-size: 0.95rem; }
            .block-label { margin-bottom: 8px; }
            
            .schematic-label.left::before, .schematic-label.right::before { width: 20px; }
            .schematic-label span { font-size: 9px; padding: 3px 6px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="viz-viewport">
        <div class="model-card" id="model-container">
            
            <div class="viewport-header">
                <h2>PRODUCT X Prefilled Injection Device</h2>
                <p>PRODUCT X offers a proprietary delivery system and formulation designed with you and your patient’s experience in mind.</p>
            </div>

            <canvas id="webgl-canvas"></canvas>
            
            <div id="label-needle" class="schematic-label left"><span>Needle & Cap</span></div>
            <div id="label-front-stopper" class="schematic-label left"><span>Front Stopper</span></div>
            <div id="label-powder" class="schematic-label left"><span>Leuprolide Acetate<br>Microsphere Powder</span></div>
            <div id="label-diluent" class="schematic-label left"><span>Diluent</span></div>
            <div id="label-plunger" class="schematic-label left"><span>Plunger</span></div>
            
            <div id="label-safety" class="schematic-label right"><span>LuproLoc®<br>Safety Device</span></div>
            <div id="label-barrel" class="schematic-label right"><span>Barrel</span></div>
            <div id="label-mid-stoppers" class="schematic-label right"><span>Middle Stoppers</span></div>
            <div id="label-end-stopper" class="schematic-label right"><span>End Stopper</span></div>
            <div id="label-finger-grip" class="schematic-label right"><span>Finger Grip</span></div>

            <div id="anno-needle" class="annotation"><div class="annotation-title">Fine 23-gauge needle +</div></div>
            <div id="anno-safety" class="annotation"><div class="annotation-title">LuproLoc® safety +</div></div>
            <div id="anno-microspheres" class="annotation"><div class="annotation-title">Lyophilized microsphere technology +</div></div>
            <div id="anno-diluent" class="annotation"><div class="annotation-title">Diluent +</div></div>
            <div id="anno-dual" class="annotation"><div class="annotation-title">Prefilled dual-chamber syringe +</div></div>
            <div id="anno-plunger" class="annotation"><div class="annotation-title">Plunger +</div></div>
        </div>
    </div>

    <div class="rail" id="scroll-rail">
        
        <div class="text-block" id="step-1">
            <div class="content-box">
                <span class="block-label">PRODUCT X Prefilled Injection Device</span>
                <p>An interactive exploration of Product X's proprietary delivery system.</p>
                <div class="scroll-prompt">
                    Scroll to continue
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
                </div>
            </div>
        </div>
        <div class="text-block" id="step-2">
            <div class="content-box">
                <span class="block-label">Fine 23-gauge needle</span>
                <p>The active drug, leuprolide acetate, is embedded in microcapsules composed of a biodegradable, hydrophobic polymer to overcome high solubility in body fluids and rapid excretion in vivo.</p>
            </div>
        </div>
        <div class="text-block" id="step-3">
            <div class="content-box">
                <span class="block-label">LuproLoc® safety</span>
                <p>After withdrawing the syringe, activate the LuproLoc® safety device by pushing the arrow on the lock upward toward the needle tip with your thumb or finger until the needle cover fully extends and a CLICK is heard or felt.</p>
            </div>
        </div>
        <div class="text-block" id="step-4">
            <div class="content-box">
                <span class="block-label">Lyophilized microsphere technology</span>
                <p>Product X is formulated with lyophilized microsphere technology, gradually releasing active drug from each microsphere over time.</p>
            </div>
        </div>
        <div class="text-block" id="step-5">
            <div class="content-box">
                <span class="block-label">Diluent</span>
                <p>Sterile liquid used to hydrate and dissolve the lyophilized microsphere powder.</p>
            </div>
        </div>
        <div class="text-block" id="step-6">
            <div class="content-box">
                <span class="block-label">Prefilled dual-chamber syringe</span>
                <p>Dual‑chamber, prefilled syringe system that stores the diluent and lyophilized microsphere powder separately. Activating the plunger releases the diluent for in‑syringe mixing prior to injection.</p>
            </div>
        </div>
        <div class="text-block" id="step-7">
            <div class="content-box">
                <span class="block-label">Plunger</span>
                <p>Screw the white plunger into the end stopper to release the diluent into the lyophilized microsphere powder. Gently shake the prefilled dual‑chamber syringe to mix—no external mixing required.</p>
            </div>
        </div>
    </div>
</div>

<script>
    const canvas = document.getElementById('webgl-canvas');
    const container = document.getElementById('model-container');
    const scene = new THREE.Scene();
    
    const camera = new THREE.PerspectiveCamera(30, container.clientWidth / container.clientHeight, 0.1, 100);
    camera.position.set(0, 0, 42); 

    // Disabled real-time shadows for a cleaner AO look
    const renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true, alpha: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setClearColor(0x000000, 0);

    const ambientLight = new THREE.AmbientLight(0xffffff, 0.9);
    scene.add(ambientLight);
    
    const mainLight = new THREE.DirectionalLight(0xffffff, 1.0);
    mainLight.position.set(10, 20, 15);
    scene.add(mainLight);

    const rimLight = new THREE.DirectionalLight(0xffffff, 0.8);
    rimLight.position.set(-10, 5, -10);
    scene.add(rimLight);

    // --- REALISTIC MATERIALS ---
    const glassMat = new THREE.MeshPhysicalMaterial({ 
        color: 0x99ccff, metalness: 0.1, roughness: 0.05, transmission: 0.88, opacity: 1, transparent: true, clearcoat: 1.0, clearcoatRoughness: 0.1
    });
    const plasticMat = new THREE.MeshPhysicalMaterial({ 
        color: 0x88bbff, metalness: 0.0, roughness: 0.2, transmission: 0.75, opacity: 1, transparent: true, depthWrite: false 
    });
    const rubberMat = new THREE.MeshStandardMaterial({ color: 0x333333, roughness: 0.9 }); 
    const purpleMat = new THREE.MeshStandardMaterial({ color: 0x47315a, roughness: 0.4 }); 
    const diluentMat = new THREE.MeshPhysicalMaterial({ color: 0xffffff, transmission: 0.8, opacity: 0.8, transparent: true, roughness: 0 });
    const powderMat = new THREE.MeshStandardMaterial({ color: 0xfdfdfd, roughness: 1.0 });

    // New Cap Material (Frosted, semi-transparent plastic)
    const capMat = new THREE.MeshPhysicalMaterial({ 
        color: 0xeeeeee, metalness: 0.0, roughness: 0.3, transmission: 0.6, opacity: 1, transparent: true, depthWrite: false 
    });

    // --- ASSEMBLE SYRINGE ---
    const syringeGroup = new THREE.Group();
    const baseY = -2.0; 
    syringeGroup.position.y = baseY;

    const barrelGeo = new THREE.CylinderGeometry(0.7, 0.7, 8, 32);
    const barrel = new THREE.Mesh(barrelGeo, glassMat);
    syringeGroup.add(barrel);

    const labelCanvas = document.createElement('canvas');
    labelCanvas.width = 512; labelCanvas.height = 256;
    const ctx = labelCanvas.getContext('2d');
    ctx.fillStyle = '#47315a'; ctx.fillRect(0, 0, 512, 106); 
    ctx.fillStyle = 'rgba(255, 255, 255, 0.85)'; ctx.fillRect(0, 106, 512, 150); 
    ctx.fillStyle = '#fff'; ctx.font = 'bold 36px Arial'; ctx.fillText('30 mg', 20, 50);
    ctx.font = '24px Arial'; ctx.fillText('for 4-month administration', 130, 50);
    ctx.fillStyle = '#333'; ctx.font = 'bold 38px Arial'; ctx.fillText('LUPRON DEPOT®', 20, 160);
    ctx.font = '28px Arial'; ctx.fillText('(leuprolide acetate', 20, 200);
    ctx.fillText('for depot suspension)', 20, 230);
    
    const labelTexture = new THREE.CanvasTexture(labelCanvas); 
    const labelGeo = new THREE.CylinderGeometry(0.71, 0.71, 3.0, 32, 1, true, Math.PI*1.5, Math.PI); 
    const labelMat = new THREE.MeshStandardMaterial({ map: labelTexture, side: THREE.DoubleSide, transparent: true, roughness: 0.5 });
    const label = new THREE.Mesh(labelGeo, labelMat);
    label.position.y = 1.2; 
    syringeGroup.add(label);

    const drugCakeGeo = new THREE.CylinderGeometry(0.65, 0.65, 1.5, 32);
    const drugCake = new THREE.Mesh(drugCakeGeo, powderMat);
    drugCake.position.y = 2.5; 
    syringeGroup.add(drugCake);

    const frontStopperGeo = new THREE.CylinderGeometry(0.68, 0.68, 0.3, 32);
    const frontStopper = new THREE.Mesh(frontStopperGeo, rubberMat);
    frontStopper.position.y = 3.5;
    syringeGroup.add(frontStopper);

    const midStopper1Geo = new THREE.CylinderGeometry(0.68, 0.68, 0.3, 32);
    const midStopper1 = new THREE.Mesh(midStopper1Geo, rubberMat);
    midStopper1.position.y = 0.4;
    syringeGroup.add(midStopper1);

    const midStopper2Geo = new THREE.CylinderGeometry(0.68, 0.68, 0.3, 32);
    const midStopper2 = new THREE.Mesh(midStopper2Geo, rubberMat);
    midStopper2.position.y = 0.9;
    syringeGroup.add(midStopper2);

    const diluentGeo = new THREE.CylinderGeometry(0.65, 0.65, 2.5, 32);
    const diluent = new THREE.Mesh(diluentGeo, diluentMat);
    diluent.position.y = -1.2;
    syringeGroup.add(diluent);

    const plungerGroup = new THREE.Group();
    const endStopperGeo = new THREE.CylinderGeometry(0.68, 0.68, 0.5, 32);
    const endStopper = new THREE.Mesh(endStopperGeo, rubberMat);
    endStopper.position.y = -2.7; 
    plungerGroup.add(endStopper);

    const rodGeo = new THREE.CylinderGeometry(0.3, 0.3, 5, 16);
    const rod = new THREE.Mesh(rodGeo, purpleMat); 
    rod.position.y = -5.2;
    plungerGroup.add(rod);

    function BoxGeometryWidthRounded(width, height, depth, radius0, smoothness) {
        let shape = new THREE.Shape();
        let eps = 0.00001;
        let radius = radius0 - eps;
        shape.absarc( eps, eps, eps, -Math.PI / 2, -Math.PI, true );
        shape.absarc( eps, height -  radius * 2, eps, Math.PI, Math.PI / 2, true );
        shape.absarc( width - radius * 2, height -  radius * 2, eps, Math.PI / 2, 0, true );
        shape.absarc( width - radius * 2, eps, eps, 0, -Math.PI / 2, true );
        let geometry = new THREE.ExtrudeGeometry( shape, { depth: depth - radius0 * 2, bevelEnabled: true, bevelSegments: smoothness * 2, steps: 1, bevelSize: radius, bevelThickness: radius0, curveSegments: smoothness });
        geometry.center();
        return geometry;
    }
    const thumbGeo = new BoxGeometryWidthRounded(2.4, 0.3, 1.4, 0.1, 4); 
    const thumb = new THREE.Mesh(thumbGeo, purpleMat); 
    thumb.position.y = -7.7;
    plungerGroup.add(thumb);
    syringeGroup.add(plungerGroup);

    const hubGeo = new THREE.CylinderGeometry(0.3, 0.7, 0.8, 32);
    const hubMat = new THREE.MeshStandardMaterial({ color: 0xdddddd, transparent: true, opacity: 0.9 });
    const hub = new THREE.Mesh(hubGeo, hubMat);
    hub.position.y = 4.4;
    syringeGroup.add(hub);

    const needleGeo = new THREE.CylinderGeometry(0.025, 0.025, 2.8, 16); 
    const needleMat = new THREE.MeshStandardMaterial({ color: 0xaaaaaa, metalness: 0.8, roughness: 0.2 });
    const needle = new THREE.Mesh(needleGeo, needleMat);
    needle.position.y = 6.2;
    syringeGroup.add(needle);

    // Add the Rigid Needle Cap
    const capGeo = new THREE.CylinderGeometry(0.1, 0.28, 3.2, 32);
    const needleCap = new THREE.Mesh(capGeo, capMat);
    needleCap.position.y = 6.4; // Positioned perfectly over the needle and hub
    syringeGroup.add(needleCap);

    const safetyGroup = new THREE.Group();
    const safetyShieldGeo = new THREE.CylinderGeometry(0.85, 0.85, 4.0, 32);
    const safetyShield = new THREE.Mesh(safetyShieldGeo, plasticMat);
    safetyGroup.add(safetyShield);

    const tabGeo = new THREE.BoxGeometry(1.0, 1.2, 0.5);
    const tab = new THREE.Mesh(tabGeo, plasticMat);
    tab.position.set(0, -1.4, 0.85);
    safetyGroup.add(tab);

    const arrowGeo = new THREE.ConeGeometry(0.2, 0.4, 3);
    const arrowMat = new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.5 });
    const arrow = new THREE.Mesh(arrowGeo, arrowMat);
    arrow.position.set(0, -1.4, 1.15); 
    arrow.rotation.x = 0; 
    safetyGroup.add(arrow);
    
    safetyGroup.position.y = 1.0;
    syringeGroup.add(safetyGroup);

    syringeGroup.rotation.y = -Math.PI / 6; 
    scene.add(syringeGroup);

    // --- CREATE TRUE AMBIENT OCCLUSION SHADOW (DARKER) ---
    function createSoftShadowTexture() {
        const canvas = document.createElement('canvas');
        canvas.width = 512; canvas.height = 512; 
        const ctx = canvas.getContext('2d');

        const gradient = ctx.createRadialGradient(
            canvas.width / 2, canvas.height / 2, 0, 
            canvas.width / 2, canvas.height / 2, canvas.width / 2
        );
        
        // Much darker center (50% opacity), smoother falloff to transparent
        gradient.addColorStop(0, 'rgba(0,0,0,0.5)');
        gradient.addColorStop(0.4, 'rgba(0,0,0,0.15)');
        gradient.addColorStop(1, 'rgba(0,0,0,0)'); 

        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        const texture = new THREE.CanvasTexture(canvas);
        texture.minFilter = THREE.LinearFilter;
        return texture;
    }

    const shadowTexture = createSoftShadowTexture();
    const shadowPlaneMat = new THREE.MeshBasicMaterial({
        map: shadowTexture, transparent: true, opacity: 1, depthWrite: false, side: THREE.DoubleSide
    });
    const shadowPlaneGeo = new THREE.PlaneGeometry(12, 24);
    const shadowPlane = new THREE.Mesh(shadowPlaneGeo, shadowPlaneMat);
    shadowPlane.position.set(0, baseY, -3.0); 
    scene.add(shadowPlane);

    // --- PROJECTION HELPER FOR LABELS ---
    function updateLabelPosition(mesh, elementId, yOffset = 0) {
        const el = document.getElementById(elementId);
        if (!el) return;

        const vector = new THREE.Vector3();
        mesh.getWorldPosition(vector);
        vector.y += yOffset; 
        vector.project(camera);

        const x = (vector.x * 0.5 + 0.5) * container.clientWidth;
        const y = (vector.y * -0.5 + 0.5) * container.clientHeight;

        el.style.left = `${x}px`;
        el.style.top = `${y}px`;
    }

    function animate() {
        requestAnimationFrame(animate);
        if(!gsap.isTweening(syringeGroup.position)) {
            const floatY = baseY + Math.sin(performance.now() * 0.0008) * 0.1; 
            syringeGroup.position.y = floatY;
            shadowPlane.position.y = floatY * 0.8; 
        }
        
        updateLabelPosition(needle, 'label-needle');
        updateLabelPosition(safetyGroup, 'label-safety', -0.5); 
        updateLabelPosition(frontStopper, 'label-front-stopper');
        updateLabelPosition(barrel, 'label-barrel', 2); 
        updateLabelPosition(drugCake, 'label-powder');
        updateLabelPosition(midStopper1, 'label-mid-stoppers', 0.25); 
        updateLabelPosition(diluent, 'label-diluent');
        updateLabelPosition(endStopper, 'label-end-stopper');
        updateLabelPosition(rod, 'label-plunger', -1);
        updateLabelPosition(thumb, 'label-finger-grip');

        renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    });

    function resetOverlays() {
        document.querySelectorAll('.annotation').forEach(el => el.classList.remove('visible'));
    }

    function triggerStepAnimation(stepId) {
        resetOverlays();
        const config = { duration: 1.2, ease: "power2.inOut" }; 

        const schematicLabels = document.querySelectorAll('.schematic-label');
        
        // LOGIC FOR STEP 1 (OVERVIEW)
        if (stepId === 'step-1') {
            schematicLabels.forEach(el => el.classList.add('show'));
            
            gsap.to(camera.position, { ...config, x: 0, y: 0, z: 42 });
            gsap.to(syringeGroup.rotation, { ...config, x: 0, y: -Math.PI / 6, z: 0 });
            gsap.to(syringeGroup.position, { ...config, x: 0, y: baseY });
            
            gsap.to(safetyGroup.position, { ...config, y: 1.0 });
            gsap.to(plungerGroup.position, { ...config, y: 0 });
            gsap.to(diluent.position, { ...config, y: -1.2 });
            gsap.to(midStopper1.position, { ...config, y: 0.4 });
            gsap.to(midStopper2.position, { ...config, y: 0.9 });
            gsap.to(drugCake.scale, { ...config, y: 1, x: 1, z: 1 });
            gsap.to(drugCake.position, { ...config, y: 2.5 });

            // Ensure Cap is ON and Visible
            gsap.to(needleCap.position, { ...config, y: 6.4 });
            gsap.to(needleCap.material, { duration: 0.8, opacity: 1 });

        } else {
            // Logic for all other steps: Hide schematic labels, remove cap
            schematicLabels.forEach(el => el.classList.remove('show'));
            
            // Slide cap off and fade it out to reveal the needle
            gsap.to(needleCap.position, { ...config, y: 10.0 });
            gsap.to(needleCap.material, { duration: 0.8, opacity: 0 });

            if (stepId === 'step-2') {
                gsap.to(camera.position, { ...config, x: 0, y: 5.5, z: 12 });
                gsap.to(syringeGroup.rotation, { ...config, x: 0, y: -Math.PI / 4, z: 0 });
                gsap.to(syringeGroup.position, { ...config, x: 0, y: baseY });
                
                gsap.to(safetyGroup.position, { ...config, y: 1.0 });
                
                setTimeout(() => document.getElementById('anno-needle').classList.add('visible'), 600);

            } else if (stepId === 'step-3') {
                gsap.to(camera.position, { ...config, x: 0, y: 3.5, z: 15 });
                gsap.to(syringeGroup.rotation, { ...config, x: 0, y: -Math.PI / 4, z: 0 });
                gsap.to(syringeGroup.position, { ...config, x: 0, y: baseY });
                
                gsap.to(safetyGroup.position, { duration: 0.8, y: 5.7, ease: "back.out(1.2)" });
                
                setTimeout(() => document.getElementById('anno-safety').classList.add('visible'), 400);

            } else if (stepId === 'step-4') {
                gsap.to(camera.position, { ...config, x: 0, y: 2.5, z: 12 });
                gsap.to(syringeGroup.rotation, { ...config, x: 0, y: -Math.PI / 6, z: 0 }); 
                gsap.to(syringeGroup.position, { ...config, x: 0, y: baseY });
                
                gsap.to(safetyGroup.position, { ...config, y: 1.0 }); 
                
                setTimeout(() => document.getElementById('anno-microspheres').classList.add('visible'), 600);

            } else if (stepId === 'step-5') {
                gsap.to(camera.position, { ...config, x: 0, y: -1.2, z: 12 });
                gsap.to(syringeGroup.rotation, { ...config, x: 0, y: -Math.PI / 6, z: 0 });
                gsap.to(syringeGroup.position, { ...config, x: 0, y: baseY });
                
                gsap.to(safetyGroup.position, { ...config, y: 1.0 });
                gsap.to(plungerGroup.position, { ...config, y: 0 });
                gsap.to(diluent.position, { ...config, y: -1.2 });
                gsap.to(midStopper1.position, { ...config, y: 0.4 });
                gsap.to(midStopper2.position, { ...config, y: 0.9 });
                gsap.to(drugCake.scale, { ...config, y: 1, x: 1, z: 1 });
                gsap.to(drugCake.position, { ...config, y: 2.5 });

                setTimeout(() => document.getElementById('anno-diluent').classList.add('visible'), 600);

            } else if (stepId === 'step-6') {
                gsap.to(camera.position, { ...config, x: 0, y: 0.5, z: 24 });
                gsap.to(syringeGroup.rotation, { ...config, x: 0, y: -Math.PI / 6, z: 0 });
                gsap.to(syringeGroup.position, { ...config, x: 0, y: baseY });
                
                gsap.to(safetyGroup.position, { ...config, y: 1.0 });
                gsap.to(plungerGroup.position, { ...config, y: 0 });
                gsap.to(diluent.position, { ...config, y: -1.2 });
                gsap.to(midStopper1.position, { ...config, y: 0.4 });
                gsap.to(midStopper2.position, { ...config, y: 0.9 });
                gsap.to(drugCake.scale, { ...config, y: 1, x: 1, z: 1 });
                gsap.to(drugCake.position, { ...config, y: 2.5 });

                setTimeout(() => document.getElementById('anno-dual').classList.add('visible'), 600);

            } else if (stepId === 'step-7') {
                gsap.to(camera.position, { ...config, x: 0, y: -4, z: 24 });
                gsap.to(syringeGroup.rotation, { ...config, x: 0, y: 0, z: 0 });
                
                const mixTL = gsap.timeline({defaults: {ease: "power2.inOut", duration: 1.0}});
                
                mixTL.to(plungerGroup.position, { y: 2.5 }, 0);
                mixTL.to(diluent.position, { y: 1.3 }, 0);
                mixTL.to(midStopper1.position, { y: 2.9 }, 0.2);
                mixTL.to(midStopper2.position, { y: 3.4 }, 0.2);
                mixTL.to(drugCake.scale, { y: 0.1, x: 0.8, z: 0.8 }, 0.3);
                mixTL.to(drugCake.position, { y: 3.8 }, 0.3);

                mixTL.to(syringeGroup.position, { x: 0.2, yoyo: true, repeat: 7, duration: 0.08, ease: "sine.inOut" }, 1.2);
                mixTL.to(syringeGroup.position, { x: 0, y: baseY, duration: 0.1 }, 1.8);

                setTimeout(() => document.getElementById('anno-plunger').classList.add('visible'), 2000);
            }
        }
    }

    const obs = new IntersectionObserver(e => {
        e.forEach(entry => { 
            if(entry.isIntersecting) { 
                document.querySelectorAll('.text-block').forEach(b => b.classList.remove('active'));
                entry.target.classList.add('active'); 
                triggerStepAnimation(entry.target.id);
            } 
        });
    }, { root: document.getElementById('scroll-rail'), threshold: 0.6 });
    document.querySelectorAll('.text-block').forEach(b => obs.observe(b));
</script>
</body>
</html>